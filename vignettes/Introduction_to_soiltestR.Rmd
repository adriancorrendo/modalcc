---
title: "Introduction to soiltestR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction_to_soiltestR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=6, 
  fig.height=4
)
```

The goal of `soiltestR` is to assist users on the analysis of relationships between relative yield (RY) and soil test values (STV) following different approaches. <br/>

<img src="../man/figures/soiltestR_logo.png" height="300" align="right"/>

<b> 1. modALCC() </b> <br/>

The first calibration method available is the Modified Arcsine-log Calibration Curve (`modALCC()`) originally described by Dyson and Conyers (2013) and modified by Correndo et al. (2017). This function produces the estimation of critical soil test values (CSTV) for a target relative yield (RY) with confidence intervals at adjustable confidence levels. <br/>
  
Instructions <br/>

i. Load your dataframe with soil test value (STV) and relative yield (RY) data. <br/>

ii. Specify the following arguments into the function -modALCC()-: <br/>

  (a). `data` (optional), <br/>

  (b). soil test value `STV` and relative yield `RY`, <br/>

  (c). `target` of relative yield (e.g. 90%), <br/>

  (d). desired `confidence` level (e.g. 0.95 for 1 - alpha(0.05)). Used for the estimation of critical soil test value (CSTV) lower and upper limits. <br/>

iii. Run and check results. <br/>

iv. Check residuals plot, and warnings related to potential leverage points. <br/>

v. Adjust curve plots as desired. <br/>

`soiltestR` also allows users to implement the quadrants analysis approach, also known as the Cate-Nelson analysis. There are two versions of the Cate-Nelson technique: <br/>


<b> 1. cate.nelson.1965() </b> <br/>
   
   The second alternative is based on Cate and Nelson (1965) (`cate.nelson.1965()`). The first step of this method is to apply an arbitrarily fixed value of RY as a target (y-axis) that divides the data into two categories (below & equal or above RY target). In a second stage, it estimates the CSTV (x-axis) as the minimum STV that divides the data into four quadrants (target RY level combined with STV lower or greater than the CSTV) maximizing the number of points under well-classified quadrants (II, STV >= CSTV & RY >= RY target; and IV, STV < CSTV & RY < RY target). This is also known as the "graphical" version of the Cate-Nelson approach. <br/>
   
Instructions <br/>

i. Load your dataframe with soil test value (STV) and relative yield (RY) data. <br/>

ii. Specify the following arguments into the function -cate.nelson.1965()-: <br/>

  (a). `data` (optional), <br/>

  (b). soil test value `STV` and relative yield `RY`, <br/>

  (c). `target` of relative yield (e.g. 90%), <br/>

  
iii. Run and check results. <br/>

iv. Adjust plot as desired. <br/>

<b> 1. cate.nelson.1971() </b> <br/>
   
   The third alternative is based on Cate and Nelson (1971) (`cate.nelson.1971()`). The first step of this alternative version is to estimates the CSTV (x-axis) as the minimum STV that minimizes the residual sum of squares when dividing data points in two classes (lower or greater than the CSTV) without using a fixed RY. This refined version does not constrains the model performance (measured with the coefficient of determination -R2-) but the user has no control on the RY level for the CSTV. This is also known as the "statistical" version of the Cate-Nelson approach. <br/> 
   
Instructions <br/>

i. Load your dataframe with soil test value (STV) and relative yield (RY) data. <br/>

ii. Specify the following arguments into the function -cate.nelson.1965()-: <br/>

  (a). `data` (optional), <br/>

  (b). soil test value `STV` and relative yield `RY`, <br/>

  
iii. Run and check results. <br/>

iv. Adjust plot as desired. <br/>
   
   
MORE FUNCTIONS COMING SOON.... <br/>

   
## 1. Installation

You can install the development version of modalcc from [GitHub](https://github.com/adriancorrendo/soiltestR) with:

``` r
# install.packages("devtools")
devtools::install_github("adriancorrendo/soiltestR")

```

```{r setup}
library(soiltestR)
```


## 2. Example

This is a basic example which shows you how to use the package: <br/>

Complementary libraries
```{r warning=FALSE, message=FALSE}
# Other suggested packages
# Install if needed 
library(ggplot2) # Plots
library(ggpp) 
library(dplyr) # Data wrangling
library(tidyr) # Data wrangling
library(purrr) # Mapping


```

### 2.1. Load a dataset
```{r}

# Example 1 dataset
# Fake dataset manually created
data_1 = data.frame("RY" = c(65,80,85,88,90,94,93,96,97,95,98,100,99,99,100),
                   "STV" = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15))
  

# Example 2. Native dataset from modalcc package

data_2 = soiltestR::data_test

# Example 3. Native dataset from soiltestR package, used by Cate & Nelson (1971)
data_3 <- soiltestR::freitas1966

# Create nested structure as example of multiple datasets
# Note that STV column needs to have the same name in order to bind rows
data.all = bind_rows(data_1, data_2, 
                     data_3 %>% dplyr::rename(STV = STK),
                     .id = "id") %>% 
  tidyr::nest(data = c("STV", "RY"))

```

## 3. Fit examples <br/>

### 3.1. Fit ALCC models individually
```{r warning=TRUE, message=TRUE}

# RY target = 90%, confidence level = 0.95, replace with your desired values

# Data 1
# Using dataframe
fit_example_1 = soiltestR::modALCC(data = data_1, RY = RY, STV = STV, target=90, confidence = 0.95)
# Alternative using the vectors
#fit_example_1 = ALCC(RY = data_1$RY,STV = data_1$STV, target=90,confidence = 0.95)

fit_example_1

# Data 2
fit_example_2 = soiltestR::modALCC(data = data_2, RY = RY, STV = STV, target=90, confidence = 0.95)

fit_example_2

# Data 3. Freitas et al. 1966
fit_example_3 = soiltestR::modALCC(data = data_3, RY = RY, STV = STK, target=90, confidence = 0.95)

fit_example_3


```

### 3.1.2. Fit multiple ALCC models with mapping

```{r warning=T, message=F}
# Run multiple examples at once with map()
fit_examples = data.all %>%
  mutate(modALCC = map(data, ~ soiltestR::modALCC(RY = .$RY, STV = .$STV, target=90, confidence = 0.95))) 

head(fit_examples)

# Alternative with group_map, this does not required nested data.
fit_all = bind_rows(data_1, data_2, .id = "id") %>% 
  group_by(id) %>% 
  group_map(~ soiltestR::modALCC(data = ., RY = RY, STV = STV, target = 90, confidence = 0.95))

head(fit_all)
```

### 3.2. Fit Cate & Nelson 1965
```{r}

cate.nelson.1965_example_2 = soiltestR::cate.nelson.1965(data = data_2, RY = RY, STV = STV, target=90, tidy = FALSE, plot = FALSE)

cate.nelson.1965_example_2

cate.nelson.1965_example_3 = soiltestR::cate.nelson.1965(data = data_3, RY = RY, STV = STK, target=95, tidy = TRUE, plot = FALSE)

cate.nelson.1965_example_3


```

### 3.3. Fit Cate & Nelson 1971
```{r}

cate.nelson.1971_example_2 = soiltestR::cate.nelson.1971(data = data_2, RY = RY, STV = STV, tidy = TRUE, plot = FALSE)

cate.nelson.1971_example_2

cate.nelson.1971_example_3 = soiltestR::cate.nelson.1971(data = data_3, RY = RY, STV = STK, tidy = TRUE, plot = FALSE)

cate.nelson.1971_example_3

```

### 3.4. Fit Linear-plateau model
```{r}

#linear_plateau_example_3 = soiltestR::linear_plateau(data = data_3, RY = RY, STV = STK, plot = FALSE)

#linear_plateau_example_3

```

## 4. Plots

Examples using ggplot <br/>

### 4.1. modALCC
```{r warning=F, message=F}

soiltestR::modALCC(data = data_3, RY = RY, STV = STK, target=95, confidence = 0.95, plot = TRUE)

# SMA regression

SMA_example3 = fit_example_3$SMA %>% as.data.frame()
 
SMA_example3 %>% 
  ggplot(aes(x = arc_RY, y = ln_STV))+
  ggtitle("SMA Regression. Dataset 3")+
  geom_point(shape=21, fill = "orange", size = 4, alpha = 0.75)+
  #SMA Line
  geom_path(aes(x=arc_RY, y = SMA_line, linetype = "SMA_fit"), size = 2, col = "grey25")+
  scale_linetype_manual(name="", values = c("solid"))+
  #Critical value
  geom_vline(xintercept = 0, col = "grey10", size = 1.25, linetype = "dashed")+
  theme_bw()+
  # Axis titles
  labs(y = "ln_STV", y = "asin(sqrt(RY))-centered")

# Residuals plot

SMA_example3 %>% 
  ggplot(aes(x = fitted_axis, y = residuals))+
  ggtitle("Residuals SMA. Dataset 3")+
  geom_point(shape=21, fill = "orange", size = 4, alpha = 0.75)+
  geom_hline(yintercept = 0, col = "grey10", size = 1.25, linetype = "dashed")+
  theme_bw()+
  # Axis titles
  labs(x = "Fitted Axis -SMA- (see Warton et al. 2006)", y = "Residuals (STV units)")

```

\newpage

### 4.2. Cate & Nelson 1965
```{r warning=F, message=F}

soiltestR::cate.nelson.1965(data = data_3, RY = RY, STV = STK, target=95, tidy = TRUE, plot = TRUE)

```

### 4.3. Cate & Nelson 1971
```{r warning=F, message=F}

soiltestR::cate.nelson.1971(data = data_3, RY = RY, STV = STK, tidy = TRUE, plot = TRUE)

```

### 4.4. Linear-plateau
```{r warning=F, message=F}

#soiltestR::linear_plateau(data = data_3, RY = RY, STV = STK, plot = TRUE, resid = TRUE)

```

<b> References </b> <br/>

*Correndo, A.A., Salvagiotti, F., García, F.O. and Gutiérrez-Boem, F.H., 2017. A modification of the arcsine–log calibration curve for analysing soil test value–relative yield relationships. Crop and Pasture Science, 68(3), pp.297-304. https://doi.org/10.1071/CP16444 * <br/>

*Cate, R.B. Jr., and Nelson, L.A., 1965. A rapid method for correlation of soil test analysis with plant response data. North Carolina Agric. Exp. Stn., International soil Testing Series Bull. No. 1. * <br/>

*Cate, R.B. Jr., and Nelson, L.A., 1971. A simple statistical procedure for partitioning soil test correlation data into two classes. Soil Sci. Soc. Am. Proc. 35:658-659 * <br/>

*Dyson, C.B., Conyers, M.K., 2013. Methodology for online biometric analysis of soil test-crop response datasets. Crop & Pasture Science 64: 435–441. https://doi.org/10.1071/CP13009 * <br/>

*Warton, D.I., Wright, I.J., Falster, D.S., Westoby, M., 2006. Bivariate line-fitting methods for allometry. Biol. Rev. Camb. Philos. Soc. 81, 259–291. https://doi.org/10.1017/S1464793106007007 * <br/>